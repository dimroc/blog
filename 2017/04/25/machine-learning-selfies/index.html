<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!--iPhone preview -->
  <meta property="og:title" content="Automatic Selfie Segmentation and Style Transfer" />
  <meta property="og:image" content="/public/images/machine-learning-selfie-segmentation/matte_140.jpg" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Automatic Selfie Segmentation and Style Transfer &middot; dimroc
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/tagging.css">
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="/public/css/custom.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

  <!-- Javascript -->
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
  <script src="/public/javascript/detectmobilebrowser.js"></script>

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  <meta name="google-site-verification" content="KFJOcbe4F4sAQcx11yd_6hmxu0DVdy6ZgI7y6TFK8VU" />
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-43559997-2', 'auto');
  ga('send', 'pageview');
</script>

</head>


  <body class="sidebar-overlay">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Blog</a>
    <a class="sidebar-nav-item" href="https://github.com/dimroc">GitHub</a>
    <a class="sidebar-nav-item" href="https://experiments.dimroc.com">Experiments</a>

    

    
    
      
        
      
    
      
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    

    <a class="sidebar-nav-item" href="https://twitter.com/dimroc">@dimroc</a>
  </nav>

  <div class="sidebar-item">
    <p>Tags</p>
  </div>

  <nav class="sidebar-nav">
    
    
      <a class="sidebar-nav-item" href=/tag/webgl/>webgl</a>
    
      <a class="sidebar-nav-item" href=/tag/javascript/>javascript</a>
    
      <a class="sidebar-nav-item" href=/tag/twitter/>twitter</a>
    
      <a class="sidebar-nav-item" href=/tag/nyc/>nyc</a>
    
      <a class="sidebar-nav-item" href=/tag/elasticsearch/>elasticsearch</a>
    
      <a class="sidebar-nav-item" href=/tag/ios/>ios</a>
    
      <a class="sidebar-nav-item" href=/tag/ruby/>ruby</a>
    
      <a class="sidebar-nav-item" href=/tag/elixir/>elixir</a>
    
      <a class="sidebar-nav-item" href=/tag/golang/>golang</a>
    
      <a class="sidebar-nav-item" href=/tag/scala/>scala</a>
    
      <a class="sidebar-nav-item" href=/tag/etl/>etl</a>
    
      <a class="sidebar-nav-item" href=/tag/swift/>swift</a>
    
      <a class="sidebar-nav-item" href=/tag/testing/>testing</a>
    
      <a class="sidebar-nav-item" href=/tag/rails/>rails</a>
    
      <a class="sidebar-nav-item" href=/tag/python/>python</a>
    
      <a class="sidebar-nav-item" href=/tag/business/>business</a>
    
      <a class="sidebar-nav-item" href=/tag/go/>go</a>
    
      <a class="sidebar-nav-item" href=/tag/docker/>docker</a>
    
      <a class="sidebar-nav-item" href=/tag/react/>react</a>
    
      <a class="sidebar-nav-item" href=/tag/tutum/>tutum</a>
    
      <a class="sidebar-nav-item" href=/tag/aws/>aws</a>
    
      <a class="sidebar-nav-item" href=/tag/machine-learning/>machine-learning</a>
    
      <a class="sidebar-nav-item" href=/tag/angular/>angular</a>
    
      <a class="sidebar-nav-item" href=/tag/finance/>finance</a>
    
      <a class="sidebar-nav-item" href=/tag/books/>books</a>
    
      <a class="sidebar-nav-item" href=/tag/octave/>octave</a>
    
      <a class="sidebar-nav-item" href=/tag/kubernetes/>kubernetes</a>
    
      <a class="sidebar-nav-item" href=/tag/coreml/>coreml</a>
    
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2023. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h2 class="masthead-title">
            <a href="/" title="Home">dimroc</a>
            <small>blog</small>
            <span class="masthead-links">
              <a href="https://experiments.dimroc.com" title="Experiments">See Experiments</a>
            </span>
          </h2>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Automatic Selfie Segmentation and Style Transfer</h1>
  <span class="post-date">25 Apr 2017</span>
  <span class="post-comments"><a href="#disqus_thread"></a></span>
  <p><a href="http://xiaoyongshen.me/webpage_portrait/index.html"><em>Inspired by Automatic Portrait Segmentation for Image Stylization</em></a>
and <em><a href="https://github.com/lengstrom/fast-style-transfer">Fast Style Transfer</a></em>.</p>

<p>Selfies are dominating photography, so why not experiment in that space? As I ramp up
on machine learning and neural networks, I apply a technique called object segmentation to my face
with mixed results but a promising future. This is all heavily inspired by the paper
<a href="http://xiaoyongshen.me/webpage_portrait/index.html">Automatic Portrait Segmentation for Image Stylization by Xiaoyong Shen, et al.</a></p>

<video src="/public/videos/allFourOutputUdniePhotoshop.mp4" controls="true" type="video/mp4" poster="/public/images/machine-learning-selfie-segmentation/mlPortraitsAllFour.jpg"></video>

<p>Flow:</p>

<ol>
  <li>Extract frames from video</li>
  <li>Generate matte using <a href="http://xiaoyongshen.me/webpage_portrait/index.html">portrait segmentation</a> on each frame
    <ul>
      <li>Uses pixel level classification between two categories: foreground and background</li>
    </ul>
  </li>
  <li><a href="https://github.com/lengstrom/fast-style-transfer">Style transfer</a> on original frame for cartoon effect</li>
  <li>Cut out foreground by using the matte as a mask on the styled frame</li>
  <li>Composite new video by placing foreground over original video</li>
</ol>

<p>This road was longer than I thought it would be. The standard neural networks that people are introduced to,
referred to as fully connected layers (FC), don’t suffice with images because it cannot scale up to many pixels.
There are simply too many nodes in the network. Instead, we use the increasingly popular Convolutional Neural Networks
that are particularly good at classifying images. But rather than merely classifying the image as a face,
we want to classify each pixel as either foreground or background.</p>

<p>For this, we use a <a href="https://docs.google.com/presentation/d/10XodYojlW-1iurpUsMoAZknQMS36p7lVIfFZ-Z7V_aY/edit#slide=id.g529579d43_1_292">Fully Convolutional Network</a>
to perform pixelwise predictions: pixels in, pixels out.</p>

<h2 id="convolutional-neural-networks-cnns">Convolutional Neural Networks (CNNs)</h2>

<p>Neural Networks for images. These are connected layers of kernels (or filters) to detect
features that a collection of pixels have, such as edges. Imagine a kernel being a 5x5 matrix of values used
to detect image properties at a specific section, or receptive field. For more information, read
these excellent articles:</p>

<ul>
  <li><a href="https://ujjwalkarn.me/2016/08/11/intuitive-explanation-convnets/">Intuitive Explanation of Convolutional Neural Networks</a></li>
  <li><a href="http://cs231n.github.io/convolutional-networks/">Architecture of Convolutional Neural Networks</a></li>
</ul>

<h2 id="fully-convolutional-networks">Fully Convolutional Networks</h2>

<p>CNNs were predominantly used to classify images. Is it a dog or cat?
Then the problem of object segmentation came, extracting the pixels that make up the dog or cat.
<a href="https://docs.google.com/presentation/d/10XodYojlW-1iurpUsMoAZknQMS36p7lVIfFZ-Z7V_aY/edit#slide=id.g529579d43_1_292">Fully Convolutional Network</a>
solves that problem.</p>

<p><a href="http://xiaoyongshen.me/webpage_portrait/index.html">Xiaoyong Shen, et al.</a> fine-tuned the
reference FCN implementation specifically for portraits, and a reimplementation of that is
what you see in this post. It is called the Portrait FCN.</p>

<h3 id="artifacts">Artifacts</h3>

<p>The matting isn’t perfect.</p>

<p><img src="/public/images/machine-learning-selfie-segmentation/matte_140.jpg" alt="Matte Imperfections" style="max-width:200px" /></p>

<p>As you can see here, the blotch in the top right is obviously not part of the selfie or the foreground, while the black blotch
in the bottom is part of the foreground.
This is because our Portrait FCN isn’t doing the best job it could, but there are better solutions out there
already, such as <a href="http://xiaoyongshen.me/webpage_portrait/index.html">Portrait FCN+</a> that uses a fixed
portrait trimap to assist the model when generating the matte.</p>

<p>I plan to take another approach however. More on that in the next experiment.</p>

<h2 id="style-transfer">Style Transfer</h2>

<p>Once we have the foreground, we use <a href="https://github.com/lengstrom/fast-style-transfer">Logan Engstrom’s style transfer</a> to take the aesthetic from
a painting, like the one shown below, and intelligently apply it to a photo, resulting in a cartoon like effect.
A style reminiscent of <a href="https://www.youtube.com/watch?v=gpDaNqSXxp0">Roger Rabbit</a>.</p>

<p><img src="/public/images/machine-learning-selfie-segmentation/udnie.jpg" alt="Udnie" style="max-width:300px" /></p>

<p><a href="https://www.youtube.com/watch?v=xVJwwWQlQ1o" target="_blank">
  <img src="/public/images/machine-learning-selfie-segmentation/fox_udnie.gif" alt="Fox Udnie" style="max-width:300px" />
</a></p>

<p>Here’s an example of style transfer on an entire video before matting:</p>

<video src="/public/videos/suit1_scaled.mp4" controls="true" type="video/mp4" style="max-width: 200px" poster="/public/images/machine-learning-selfie-segmentation/suit1_scaled.jpg">
</video>

<h2 id="wrap-up">Wrap Up</h2>

<p>This gave me fantastic exposure to machine learning on media and the world of Convolutional Neural Networks,
I plan to continue experimenting in this space, and even forked over for an external GPU (eGPU):</p>

<p><a href="https://egpu.io/external-gpu-buyers-guide-2017/">eGPU 2017 Comparison</a></p>

<p>Up until now, I’ve been using the amazing <a href="https://www.floydhub.com">Floyd Hub</a>, the Heroku for Deep Learning.
Definitely check it out. Even if you have your own hardware, it’s great to have some NVidia K80s at your disposal
to speed up experiements.</p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2019/12/31/books-worth-reading-2019/">
            Books Worth Reading 2019
            <small>31 Dec 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/12/31/books-worth-reading-2018/">
            Books Worth Reading 2018
            <small>31 Dec 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/08/12/counting-crowds-with-coreml/">
            Moving AI from the Cloud to the Edge with Crowd Count and Apple's Core ML
            <small>12 Aug 2018</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'dimroc'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'dimroc'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
  var s = document.createElement('script'); s.async = true;
  s.type = 'text/javascript';
  s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>


  </body>
</html>
