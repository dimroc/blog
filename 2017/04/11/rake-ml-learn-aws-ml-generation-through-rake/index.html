<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!--iPhone preview -->
  <meta property="og:title" content="rake ml:learn - AWS Machine Learning through rake" />
  <meta property="og:image" content="/" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      rake ml:learn - AWS Machine Learning through rake &middot; dimroc
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/tagging.css">
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="/public/css/custom.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

  <!-- Javascript -->
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
  <script src="/public/javascript/detectmobilebrowser.js"></script>

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  <meta name="google-site-verification" content="KFJOcbe4F4sAQcx11yd_6hmxu0DVdy6ZgI7y6TFK8VU" />
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-43559997-2', 'auto');
  ga('send', 'pageview');
</script>

</head>


  <body class="sidebar-overlay">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Blog</a>
    <a class="sidebar-nav-item" href="https://github.com/dimroc">GitHub</a>
    <a class="sidebar-nav-item" href="https://experiments.dimroc.com">Experiments</a>

    

    
    
      
        
      
    
      
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    

    <a class="sidebar-nav-item" href="https://twitter.com/dimroc">@dimroc</a>
  </nav>

  <div class="sidebar-item">
    <p>Tags</p>
  </div>

  <nav class="sidebar-nav">
    
    
      <a class="sidebar-nav-item" href=/tag/webgl/>webgl</a>
    
      <a class="sidebar-nav-item" href=/tag/javascript/>javascript</a>
    
      <a class="sidebar-nav-item" href=/tag/twitter/>twitter</a>
    
      <a class="sidebar-nav-item" href=/tag/nyc/>nyc</a>
    
      <a class="sidebar-nav-item" href=/tag/elasticsearch/>elasticsearch</a>
    
      <a class="sidebar-nav-item" href=/tag/ios/>ios</a>
    
      <a class="sidebar-nav-item" href=/tag/ruby/>ruby</a>
    
      <a class="sidebar-nav-item" href=/tag/elixir/>elixir</a>
    
      <a class="sidebar-nav-item" href=/tag/golang/>golang</a>
    
      <a class="sidebar-nav-item" href=/tag/scala/>scala</a>
    
      <a class="sidebar-nav-item" href=/tag/etl/>etl</a>
    
      <a class="sidebar-nav-item" href=/tag/swift/>swift</a>
    
      <a class="sidebar-nav-item" href=/tag/testing/>testing</a>
    
      <a class="sidebar-nav-item" href=/tag/rails/>rails</a>
    
      <a class="sidebar-nav-item" href=/tag/python/>python</a>
    
      <a class="sidebar-nav-item" href=/tag/business/>business</a>
    
      <a class="sidebar-nav-item" href=/tag/go/>go</a>
    
      <a class="sidebar-nav-item" href=/tag/docker/>docker</a>
    
      <a class="sidebar-nav-item" href=/tag/react/>react</a>
    
      <a class="sidebar-nav-item" href=/tag/tutum/>tutum</a>
    
      <a class="sidebar-nav-item" href=/tag/aws/>aws</a>
    
      <a class="sidebar-nav-item" href=/tag/machine-learning/>machine-learning</a>
    
      <a class="sidebar-nav-item" href=/tag/angular/>angular</a>
    
      <a class="sidebar-nav-item" href=/tag/finance/>finance</a>
    
      <a class="sidebar-nav-item" href=/tag/books/>books</a>
    
      <a class="sidebar-nav-item" href=/tag/octave/>octave</a>
    
      <a class="sidebar-nav-item" href=/tag/kubernetes/>kubernetes</a>
    
      <a class="sidebar-nav-item" href=/tag/coreml/>coreml</a>
    
      <a class="sidebar-nav-item" href=/tag/ml/>ml</a>
    
      <a class="sidebar-nav-item" href=/tag/games/>games</a>
    
      <a class="sidebar-nav-item" href=/tag/ai/>ai</a>
    
      <a class="sidebar-nav-item" href=/tag/genai/>genai</a>
    
      <a class="sidebar-nav-item" href=/tag/godot/>godot</a>
    
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2023. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h2 class="masthead-title">
            <a href="/" title="Home">dimroc</a>
            <small>blog</small>
            <span class="masthead-links">
              <a href="https://experiments.dimroc.com" title="Experiments">See Experiments</a>
            </span>
          </h2>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">rake ml:learn - AWS Machine Learning through rake</h1>
  <span class="post-date">11 Apr 2017</span>
  <span class="post-comments"><a href="#disqus_thread"></a></span>
  <p>Automating the creation of your machine learning (ML) model can allow your
services to evolve over time, automatically. This article assumes you have
used the AWS ML Web Interface or have some understanding of AWS ML.</p>

<p>Ideally, we would have a model that would use Stochastic Gradient Descent
and would learn per query. But when you want a low maintenance solution such
as <a href="https://aws.amazon.com/machine-learning/">AWS ML</a>, that isn’t an option,
since AWS ML models are immutable by design.</p>

<p>You can, however, retrain a new model and then flip the switch so queries go
to the new endpoint.</p>

<p>In our setup, achieving this requires a classic Extract, Transform, Load or <strong>ETL</strong>. This article
will be focusing on that last step <strong>Load</strong>. And the hardest step in the AWS ML <strong>load</strong>:
Creating Data Sources.</p>

<p>Before we talk about <strong>load</strong> though, let’s set up a simple extract and transform
so we all have contexa and are on the same page.</p>

<h2 id="extract">Extract</h2>

<ul>
  <li>Specific to your business logic</li>
  <li>Can be skipped in this simple example and fed directly into the transform</li>
  <li>More complicated examples might require getting data dumps from multiple databases
or other teams</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Machine</span>
  <span class="k">class</span> <span class="nc">Extractor</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">perform</span>
      <span class="no">CSV</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"tmp"</span><span class="p">,</span> <span class="s2">"extracted_data.csv"</span><span class="p">),</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">csv</span><span class="o">|</span>
        <span class="no">ImportantData</span><span class="p">.</span><span class="nf">find_each</span> <span class="k">do</span> <span class="o">|</span><span class="n">data</span><span class="o">|</span>
          <span class="n">csv</span> <span class="o">&lt;&lt;</span> <span class="n">data</span><span class="p">.</span><span class="nf">to_csv</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="transform">Transform</h2>

<ul>
  <li>Critical step involves converting your raw data into features to be ingested
by AWS Machine Learning models</li>
  <li>What those features are depends on your data and your machine learning model,
whether it be simple linear regression or a deep neural network</li>
  <li>Figuring out features is outside the scope of this article but read <a href="/2017/04/09/machine-learning-who-gave-you-that-long-id/">Machine Learning Long Ids</a>
for some more insight, or better yet, take <a href="https://www.coursera.org/learn/machine-learning">Andrew Ng’s Machine Learning Course</a></li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Machine</span>
  <span class="k">class</span> <span class="nc">Transformer</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">perform</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"tmp"</span><span class="p">,</span> <span class="s2">"extracted_data.csv"</span><span class="p">))</span>
      <span class="no">Dir</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="s1">'tmp'</span><span class="p">)</span> <span class="k">unless</span> <span class="no">File</span><span class="p">.</span><span class="nf">exists?</span><span class="p">(</span><span class="s1">'tmp'</span><span class="p">)</span>
      <span class="no">AwsMlTransformer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">"tmp/intermediary.csv"</span><span class="p">).</span><span class="nf">write</span>
      <span class="no">FeatureExpanderWriter</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"tmp/intermediary.csv"</span><span class="p">,</span> <span class="s2">"tmp/features.csv"</span><span class="p">).</span><span class="nf">write</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h1 id="load">Load</h1>

<p>This is the good stuff. Check out the steps listed in the method below and we’ll
walk through each line.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Machine</span>
  <span class="k">class</span> <span class="nc">Loader</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">perform</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"tmp"</span><span class="p">,</span><span class="s2">"features.csv"</span><span class="p">))</span>
      <span class="n">instance</span> <span class="o">=</span> <span class="n">new</span>
      <span class="n">instance</span><span class="p">.</span><span class="nf">upload_data_to_s3</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
      <span class="n">instance</span><span class="p">.</span><span class="nf">create_data_sources</span>
      <span class="n">instance</span><span class="p">.</span><span class="nf">create_model</span>
      <span class="n">instance</span><span class="p">.</span><span class="nf">create_evaluation</span>
      <span class="n">instance</span><span class="p">.</span><span class="nf">create_realtime_endpoint</span>
    <span class="k">end</span>

    <span class="o">...</span>
</code></pre></div></div>

<p>All of these make use of the AWS SDK v2 for Ruby.</p>

<h2 id="upload-data-to-s3">Upload Data to S3</h2>

<ul>
  <li>AWS ML needs access to your S3 bucket
    <ul>
      <li>This can be done with a bash script as explained <a href="http://docs.aws.amazon.com/machine-learning/latest/dg/granting-amazon-ml-permissions-to-read-your-data-from-amazon-s3.html">on Amazon’s website</a></li>
      <li>Example below uses <a href="https://aws.amazon.com/cli/">awscli</a>, which can be
installed with <code class="language-plaintext highlighter-rouge">brew install awscli</code></li>
      <li>Replace <code class="language-plaintext highlighter-rouge">dev.machinelearningservice.dimroc.com</code> with your bucket</li>
    </ul>
  </li>
</ul>

<noscript><pre>#!/bin/bash
echo &quot;Granting AWS ML access to S3 bucket dev.machinelearningservice.dimroc.com...&quot;
aws s3api put-bucket-policy --bucket dev.machinelearningservice.dimroc.com --policy file://ml_bucket_policy.json</pre></noscript>
<script src="https://gist.github.com/dimroc/61e1cf2f743a7f5ea0c56bb58dc586d2.js"> </script>

<ul>
  <li>Using the AWS Ruby SDK v2, upload the <code class="language-plaintext highlighter-rouge">features.csv</code> file</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">def</span> <span class="nf">upload_data_to_s3</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"uploading </span><span class="si">#{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> to S3..."</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">data_file</span> <span class="o">=</span> <span class="n">filename</span>

    <span class="n">client</span> <span class="o">=</span> <span class="no">Aws</span><span class="o">::</span><span class="no">S3</span><span class="o">::</span><span class="no">Client</span><span class="p">.</span><span class="nf">new</span>
    <span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
      <span class="n">client</span><span class="p">.</span><span class="nf">put_object</span><span class="p">(</span>
        <span class="ss">bucket: </span><span class="n">bucket_name</span><span class="p">,</span>
        <span class="ss">key: </span><span class="s2">"uploads/</span><span class="si">#{</span><span class="no">File</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
        <span class="ss">server_side_encryption: </span><span class="s2">"AES256"</span><span class="p">,</span>
        <span class="ss">body: </span><span class="n">f</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre></div></div>

<h2 id="create-data-sources">Create Data Sources</h2>

<p>This is the hardest step in the <strong>load</strong> stage. If all you read is this section,
you’ll be much better for it.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">def</span> <span class="nf">create_data_sources</span>
    <span class="nb">puts</span> <span class="s2">"Creating data sources from S3..."</span>

    <span class="c1"># Create Data Source For both Model and Evaluation</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">model_data_source_id</span> <span class="o">=</span> <span class="s2">"learn-mds-</span><span class="si">#{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">"</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">evaluation_data_source_id</span> <span class="o">=</span> <span class="s2">"learn-eds-</span><span class="si">#{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">"</span>

    <span class="c1"># Training</span>
    <span class="n">ml_client</span><span class="p">.</span><span class="nf">create_data_source_from_s3</span><span class="p">({</span>
      <span class="ss">data_source_id: </span><span class="n">model_data_source_id</span><span class="p">,</span>
      <span class="ss">data_source_name: </span><span class="s2">"Model Source: LearnSample 0-70 </span><span class="si">#{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
      <span class="ss">compute_statistics: </span><span class="kp">true</span><span class="p">,</span> <span class="c1"># Required to create ML Model</span>
      <span class="ss">data_spec: </span><span class="p">{</span>
        <span class="ss">data_location_s3: </span><span class="n">data_location</span><span class="p">,</span>
        <span class="ss">data_schema: </span><span class="n">data_schema</span><span class="p">.</span><span class="nf">to_json</span><span class="p">,</span> <span class="c1"># More on this below</span>
        <span class="ss">data_rearrangement: </span><span class="n">data_rearrangement</span><span class="p">.</span><span class="nf">to_json</span>
      <span class="p">}</span>
    <span class="p">})</span>

    <span class="n">wait_for_ml</span><span class="p">(</span><span class="ss">:data_source_available</span><span class="p">)</span> <span class="c1"># Block until complete</span>

    <span class="c1"># Evaluation</span>
    <span class="n">ml_client</span><span class="p">.</span><span class="nf">create_data_source_from_s3</span><span class="p">({</span>
      <span class="ss">data_source_id: </span><span class="n">evaluation_data_source_id</span><span class="p">,</span>
      <span class="ss">data_source_name: </span><span class="s2">"Evaluation Source: LearnSample 70-100 </span><span class="si">#{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
      <span class="ss">compute_statistics: </span><span class="kp">true</span><span class="p">,</span>
      <span class="ss">data_spec: </span><span class="p">{</span>
        <span class="ss">data_location_s3: </span><span class="n">data_location</span><span class="p">,</span>
        <span class="ss">data_schema: </span><span class="n">data_schema</span><span class="p">.</span><span class="nf">to_json</span><span class="p">,</span>
        <span class="ss">data_rearrangement: </span><span class="n">data_rearrangement</span><span class="p">(</span><span class="kp">true</span><span class="p">).</span><span class="nf">to_json</span>
      <span class="p">}</span>
    <span class="p">})</span>

    <span class="n">wait_for_ml</span><span class="p">(</span><span class="ss">:data_source_available</span><span class="p">)</span>
  <span class="k">end</span>
</code></pre></div></div>

<p>The code above performs a few key steps:</p>

<ul>
  <li>Compute statistics
    <ul>
      <li>Necessary to train the ML Model as mentioned in the <a href="http://docs.aws.amazon.com/sdkforruby/api/Aws/MachineLearning/Client.html#create_data_source_from_s3-instance_method">documentation</a></li>
    </ul>
  </li>
  <li>Data Rearragement
    <ul>
      <li>Used when you want to split a data source into two using <code class="language-plaintext highlighter-rouge">complement</code>
        <ul>
          <li><code class="language-plaintext highlighter-rouge">complement</code> tells AWS to split a data source into two, one for training
and one for evaluation. <a href="http://docs.aws.amazon.com/sdkforruby/api/Aws/MachineLearning/Client.html#create_data_source_from_s3-instance_method">Documentation</a>.</li>
          <li>
            <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">def</span> <span class="nf">data_rearrangement</span><span class="p">(</span><span class="n">complement</span><span class="o">=</span><span class="kp">false</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="ss">splitting: </span><span class="p">{</span>
        <span class="ss">percentBegin: </span><span class="mi">0</span><span class="p">,</span>
        <span class="ss">percentEnd: </span><span class="mi">70</span><span class="p">,</span>
        <span class="ss">strategy: </span><span class="s2">"random"</span><span class="p">,</span>
        <span class="ss">complement: </span><span class="n">complement</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="k">end</span>
</code></pre></div>            </div>
          </li>
        </ul>
      </li>
      <li><a href="http://docs.aws.amazon.com/machine-learning/latest/dg/data-rearrangement.html">More documentation can be found here</a></li>
    </ul>
  </li>
  <li>Data Schema
    <ul>
      <li>Describes each csv column with AWS Machine Learning metadata. The example below is for a Multiclass Classification Model</li>
      <li>
        <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"version"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"rowId"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
    </span><span class="nl">"rowWeight"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
    </span><span class="nl">"targetAttributeName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"policy"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"dataFormat"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"CSV"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"dataFileContainsHeader"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"attributes"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"attributeName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"policy"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"attributeType"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"CATEGORICAL"</span><span class="w">
    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"attributeName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"length"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"attributeType"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"NUMERIC"</span><span class="w">
    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"attributeName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"base_10"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"attributeType"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"NUMERIC"</span><span class="w">
    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"attributeName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"digit_1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"attributeType"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"NUMERIC"</span><span class="w">
    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"attributeName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"digit_2"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"attributeType"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"NUMERIC"</span><span class="w">
    </span><span class="p">}</span><span class="w"> </span><span class="p">],</span><span class="w">
    </span><span class="nl">"excludedAttributeNames"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span></code></pre></div>        </div>
      </li>
      <li><a href="http://docs.aws.amazon.com/machine-learning/latest/dg/creating-a-data-schema-for-amazon-ml.html">More information here</a></li>
    </ul>
  </li>
</ul>

<p>That was a lot. Each section warrants a decent write up, so for not, I recommend
reading the high level information about <a href="http://docs.aws.amazon.com/machine-learning/latest/dg/data-rearrangement.html">data rearrangement</a>
and <a href="http://docs.aws.amazon.com/machine-learning/latest/dg/creating-a-data-schema-for-amazon-ml.html">data schema</a>.</p>

<p>Rest assured though, it’s far simpler from here on out. The rest is really just API
calls using the IDs you just received.</p>

<h2 id="create-model-from-data-source">Create Model From Data Source</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">def</span> <span class="nf">create_model</span>
    <span class="nb">puts</span> <span class="s2">"Creating model..."</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">ml_model_id</span> <span class="o">=</span> <span class="s2">"learn-ml-</span><span class="si">#{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">ml_client</span><span class="p">.</span><span class="nf">create_ml_model</span><span class="p">({</span>
      <span class="ss">ml_model_id: </span><span class="n">ml_model_id</span><span class="p">,</span>
      <span class="ss">ml_model_name: </span><span class="s2">"ML model: LearnSample </span><span class="si">#{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
      <span class="ss">ml_model_type: </span><span class="s2">"MULTICLASS"</span><span class="p">,</span>
      <span class="ss">training_data_source_id: </span><span class="n">model_data_source_id</span><span class="p">,</span>
      <span class="ss">parameters: </span><span class="p">{</span>
        <span class="s2">"sgd.maxPasses"</span> <span class="o">=&gt;</span> <span class="s2">"20"</span><span class="p">,</span>
        <span class="s2">"sgd.shuffleType"</span> <span class="o">=&gt;</span> <span class="s2">"auto"</span>
      <span class="p">}</span>
    <span class="p">})</span>

    <span class="n">wait_for_ml</span><span class="p">(</span><span class="ss">:ml_model_available</span><span class="p">)</span>
  <span class="k">end</span>
</code></pre></div></div>

<h2 id="create-evaluation">Create Evaluation</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">def</span> <span class="nf">create_evaluation</span>
    <span class="nb">puts</span> <span class="s2">"Creating evaluation..."</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">evaluation_id</span> <span class="o">=</span> <span class="s2">"learn-ev-</span><span class="si">#{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">ml_client</span><span class="p">.</span><span class="nf">create_evaluation</span><span class="p">({</span>
      <span class="ss">evaluation_id: </span><span class="n">evaluation_id</span><span class="p">,</span>
      <span class="ss">evaluation_name: </span><span class="s2">"Evaluation: LearnSample </span><span class="si">#{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
      <span class="ss">ml_model_id: </span><span class="n">ml_model_id</span><span class="p">,</span>
      <span class="ss">evaluation_data_source_id: </span><span class="n">evaluation_data_source_id</span>
    <span class="p">})</span>

    <span class="n">wait_for_ml</span><span class="p">(</span><span class="ss">:evaluation_available</span><span class="p">)</span>
  <span class="k">end</span>
</code></pre></div></div>
<ul>
  <li>Generates a <a href="http://docs.aws.amazon.com/machine-learning/latest/dg/multiclass-model-insights.html">performance visualization</a></li>
</ul>

<p><img src="/public/images/machine-learning-ids/Multiclass_Model_Insights_-_Amazon_Machine_Learning.jpg" alt="F1 Heat Map" style="max-width:500px;" /></p>

<h2 id="create-realtime-endpoint">Create Realtime Endpoint</h2>

<p>Expose your service!</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">def</span> <span class="nf">create_realtime_endpoint</span>
    <span class="nb">puts</span> <span class="s2">"Creating realtime endpoint..."</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">ml_client</span><span class="p">.</span><span class="nf">create_realtime_endpoint</span><span class="p">({</span><span class="ss">ml_model_id: </span><span class="n">ml_model_id</span><span class="p">})</span>

    <span class="nb">puts</span> <span class="s2">"Machine Learning Complete! Update your ENV variables with the following:"</span>
    <span class="nb">puts</span>
    <span class="nb">puts</span> <span class="s2">"export AWS_ML_MODEL_ID=</span><span class="si">#{</span><span class="n">ml_model_id</span><span class="si">}</span><span class="s2">"</span>
    <span class="nb">puts</span> <span class="s2">"export AWS_ML_PREDICTION_URL=</span><span class="si">#{</span><span class="n">response</span><span class="p">.</span><span class="nf">realtime_endpoint_info</span><span class="p">.</span><span class="nf">endpoint_url</span><span class="si">}</span><span class="s2">"</span>
    <span class="nb">puts</span>
  <span class="k">end</span>
</code></pre></div></div>

<h1 id="wire-it-all-up-with-rake">Wire it all up with rake</h1>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">namespace</span> <span class="ss">:ml</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">"Transforms raw extracted data into format that's ingestable by AWS Machine Learning"</span>
  <span class="n">task</span> <span class="ss">:transform</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="no">Machine</span><span class="o">::</span><span class="no">Transformer</span><span class="p">.</span><span class="nf">perform</span>
  <span class="k">end</span>

  <span class="n">desc</span> <span class="s2">"Loads pre transformed data into AWS Machine Learning"</span>
  <span class="n">task</span> <span class="ss">:load</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="no">Machine</span><span class="o">::</span><span class="no">Loader</span><span class="p">.</span><span class="nf">perform</span>
  <span class="k">end</span>

  <span class="n">desc</span> <span class="s2">"Transform and load raw insurance number policy data into AWS Machine Learning"</span>
  <span class="n">task</span> <span class="ss">:learn</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:transform</span><span class="p">,</span> <span class="ss">:load</span><span class="p">]</span>
<span class="k">end</span>
</code></pre></div></div>

<p>In bash or your scheduled job:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rake ml:learn
</code></pre></div></div>

<p>Run it weekly to keep your machines learning.</p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2023/06/11/game-to-video-w-genai/">
            Game to Video: Using Generative AI to Uprender Gameplay
            <small>11 Jun 2023</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2019/12/31/books-worth-reading-2019/">
            Books Worth Reading 2019
            <small>31 Dec 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/12/31/books-worth-reading-2018/">
            Books Worth Reading 2018
            <small>31 Dec 2018</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'dimroc'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'dimroc'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
  var s = document.createElement('script'); s.async = true;
  s.type = 'text/javascript';
  s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>


  </body>
</html>
