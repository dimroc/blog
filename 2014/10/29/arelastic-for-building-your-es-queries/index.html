<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!--iPhone preview -->
  <meta property="og:title" content="Arelastic for your Elasticsearch Queries pt.1" />
  <meta property="og:image" content="/" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Arelastic for your Elasticsearch Queries pt.1 &middot; dimroc
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/tagging.css">
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="/public/css/custom.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

  <!-- Javascript -->
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
  <script src="/public/javascript/detectmobilebrowser.js"></script>

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  <meta name="google-site-verification" content="KFJOcbe4F4sAQcx11yd_6hmxu0DVdy6ZgI7y6TFK8VU" />
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-43559997-2', 'auto');
  ga('send', 'pageview');
</script>

</head>


  <body class="sidebar-overlay">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Blog</a>
    <a class="sidebar-nav-item" href="https://github.com/dimroc">GitHub</a>
    <a class="sidebar-nav-item" href="https://experiments.dimroc.com">Experiments</a>

    

    
    
      
        
      
    
      
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    

    <a class="sidebar-nav-item" href="https://twitter.com/dimroc">@dimroc</a>
  </nav>

  <div class="sidebar-item">
    <p>Tags</p>
  </div>

  <nav class="sidebar-nav">
    
    
      <a class="sidebar-nav-item" href=/tag/webgl/>webgl</a>
    
      <a class="sidebar-nav-item" href=/tag/javascript/>javascript</a>
    
      <a class="sidebar-nav-item" href=/tag/twitter/>twitter</a>
    
      <a class="sidebar-nav-item" href=/tag/nyc/>nyc</a>
    
      <a class="sidebar-nav-item" href=/tag/elasticsearch/>elasticsearch</a>
    
      <a class="sidebar-nav-item" href=/tag/ios/>ios</a>
    
      <a class="sidebar-nav-item" href=/tag/ruby/>ruby</a>
    
      <a class="sidebar-nav-item" href=/tag/elixir/>elixir</a>
    
      <a class="sidebar-nav-item" href=/tag/golang/>golang</a>
    
      <a class="sidebar-nav-item" href=/tag/scala/>scala</a>
    
      <a class="sidebar-nav-item" href=/tag/etl/>etl</a>
    
      <a class="sidebar-nav-item" href=/tag/swift/>swift</a>
    
      <a class="sidebar-nav-item" href=/tag/testing/>testing</a>
    
      <a class="sidebar-nav-item" href=/tag/rails/>rails</a>
    
      <a class="sidebar-nav-item" href=/tag/python/>python</a>
    
      <a class="sidebar-nav-item" href=/tag/business/>business</a>
    
      <a class="sidebar-nav-item" href=/tag/go/>go</a>
    
      <a class="sidebar-nav-item" href=/tag/docker/>docker</a>
    
      <a class="sidebar-nav-item" href=/tag/react/>react</a>
    
      <a class="sidebar-nav-item" href=/tag/tutum/>tutum</a>
    
      <a class="sidebar-nav-item" href=/tag/aws/>aws</a>
    
      <a class="sidebar-nav-item" href=/tag/machine-learning/>machine-learning</a>
    
      <a class="sidebar-nav-item" href=/tag/angular/>angular</a>
    
      <a class="sidebar-nav-item" href=/tag/finance/>finance</a>
    
      <a class="sidebar-nav-item" href=/tag/books/>books</a>
    
      <a class="sidebar-nav-item" href=/tag/octave/>octave</a>
    
      <a class="sidebar-nav-item" href=/tag/kubernetes/>kubernetes</a>
    
      <a class="sidebar-nav-item" href=/tag/coreml/>coreml</a>
    
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2023. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h2 class="masthead-title">
            <a href="/" title="Home">dimroc</a>
            <small>blog</small>
            <span class="masthead-links">
              <a href="https://experiments.dimroc.com" title="Experiments">See Experiments</a>
            </span>
          </h2>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Arelastic for your Elasticsearch Queries pt.1</h1>
  <span class="post-date">29 Oct 2014</span>
  <span class="post-comments"><a href="#disqus_thread"></a></span>
  <p><em>Update 08/2015: <a href="https://github.com/elastic/elasticsearch-ruby/tree/master/elasticsearch-dsl">Elasticsearch-ruby has its own DSL</a>.
It’s officially supported by Elasticsearch so be sure to check it out.</em></p>

<p>When doing more than just a simple search with <a href="https://github.com/elasticsearch/elasticsearch-rails/tree/master/elasticsearch-model">Elasticsearch-rails</a>,
a naive approach will lead you to this mess:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">response</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">search</span> <span class="ss">query:     </span><span class="p">{</span> <span class="ss">match:  </span><span class="p">{</span> <span class="ss">title: </span><span class="s2">"Fox Dogs"</span> <span class="p">}</span> <span class="p">},</span>
                          <span class="ss">highlight: </span><span class="p">{</span> <span class="ss">fields: </span><span class="p">{</span> <span class="ss">title: </span><span class="p">{}</span> <span class="p">}</span> <span class="p">}</span></code></pre></figure>

<p>Don’t be a sucker! Read on to see how <a href="https://github.com/matthuhiggins/arelastic">Arelastic</a> can save you pain.</p>

<!--more-->

<p>If you don’t know already, the Elasticsearch (ES) API takes a JSON hash when perfoming queries or filters or both.
Elasticsearch’s DSL is incredibly flexibly, but can quickly lead you down the path of unmaintanable hashes.</p>

<p>Here is the json for the always popular <strong>filtered query</strong>, the search for a string after removing those outside
the filter. In this case, the filter being greater than or equal to yesterday:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"filtered"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"match"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"tweet"</span><span class="p">:</span><span class="w"> </span><span class="s2">"full text search"</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"filter"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"range"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"created"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"gte"</span><span class="p">:</span><span class="w"> </span><span class="s2">"now - 1d / d"</span><span class="w"> </span><span class="p">}}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>Now let’s say you want to change the query from <strong>“full text search”</strong> to <strong>“Rihanna”</strong> (obviously). One might be tempted
to have a method that drops in a variable:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">filtered_gte_query</span><span class="p">(</span><span class="n">query_term</span><span class="p">,</span> <span class="n">filter_term</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="ss">filtered: </span><span class="p">{</span>
      <span class="ss">query: </span><span class="p">{</span>
        <span class="ss">match: </span><span class="p">{</span> <span class="ss">tweet: </span><span class="n">query_term</span> <span class="p">}</span>
      <span class="p">},</span>
      <span class="ss">filter: </span><span class="p">{</span>
        <span class="ss">range: </span><span class="p">{</span> <span class="ss">created: </span><span class="p">{</span> <span class="ss">gte: </span><span class="n">filter_term</span> <span class="p">}}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="k">end</span></code></pre></figure>

<p>And now we’re walking down the path to hell. Heaven forbid we want a filter than does less than or equal to, supports AND queries, or is chainable. The number
of methods and hashes will spiral out of control.</p>

<h2 id="introducing-arelastic">Introducing <a href="https://github.com/matthuhiggins/arelastic">Arelastic</a></h2>

<p>Modeled after Rails’ <a href="https://github.com/rails/arel">Arel</a> which is a SQL Abstract Syntax Tree (AST) manager,
Arelastic is an AST manager for Elasticsearch Queries.</p>

<p>Rather than working with hashes, you work with objects that represent nodes in the AST:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">range</span> <span class="o">=</span> <span class="no">Arelastic</span><span class="o">::</span><span class="no">Builders</span><span class="o">::</span><span class="no">Filter</span><span class="p">[</span><span class="s1">'book_id'</span><span class="p">].</span><span class="nf">gteq</span><span class="p">(</span><span class="n">filter_term</span><span class="p">)</span>
<span class="n">filter</span> <span class="o">=</span> <span class="no">Arelastic</span><span class="o">::</span><span class="no">Searches</span><span class="o">::</span><span class="no">Filter</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">range</span><span class="p">)</span>

<span class="n">query</span> <span class="o">=</span> <span class="no">Arelastic</span><span class="o">::</span><span class="no">Queries</span><span class="o">::</span><span class="no">Match</span><span class="p">.</span><span class="nf">new</span> <span class="s2">"tweet"</span><span class="p">,</span> <span class="n">query_term</span>

<span class="n">dsl</span> <span class="o">=</span> <span class="no">Arelastic</span><span class="o">::</span><span class="no">Searches</span><span class="o">::</span><span class="no">Query</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
  <span class="no">Arelastic</span><span class="o">::</span><span class="no">Queries</span><span class="o">::</span><span class="no">Filtered</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">filter</span><span class="p">)).</span><span class="nf">as_elastic</span>

<span class="no">Article</span><span class="p">.</span><span class="nf">search</span> <span class="n">dsl</span></code></pre></figure>

<p>Here’s one interesting line of code:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">Arelastic</span><span class="o">::</span><span class="no">Builders</span><span class="o">::</span><span class="no">Filter</span><span class="p">[</span><span class="s1">'book_id'</span><span class="p">].</span><span class="nf">gteq</span><span class="p">(</span><span class="o">...</span><span class="p">)</span></code></pre></figure>

<p>The <code class="language-plaintext highlighter-rouge">gteq</code> method exists alongside many other range filters, allowing one to make a chainable API much alike ActiveRecord.
Funny enough, there exists an <a href="https://github.com/data-axle/elastic_record">ElasticRecord</a> that’s built on top of this,
and precedes the new official <a href="https://github.com/elasticsearch/elasticsearch-rails">Elasticsearch-rails</a>.</p>

<p>The community is behind Elasticsearch-rails, but it has yet to introduce an Arel equivalent, and we all want to move towards that.
Here’s hoping we can take Arelastic and incorporate it into Elasticsearch-rails so we no longer have to tame unwieldy hashes.</p>

<p>Now the implementation might look cryptic, but to those familiar with ES, you can see on the ES DSL’s page <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/query-dsl-filtered-query.html">here</a>
all the query and filter nodes available, and know there’s an equivalent mapping in the Arelastic library. This would be the building block to an ORM like interface we’re far more comfortable with.</p>

<p>Then we can write Elasticsearch queries like this:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">Gift</span><span class="p">.</span><span class="nf">search_builder</span><span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="s1">'color'</span> <span class="o">=&gt;</span> <span class="s1">'red'</span><span class="p">).</span><span class="nf">match</span><span class="p">(</span><span class="s1">'flower'</span><span class="p">)</span></code></pre></figure>

<p>After <a href="https://gist.github.com/dimroc/2eec84498b6a35550f48">my first bold attempt right here</a> to create a chainable API using monads,
you can see how much simpler it is to create complicated Elasticsearch Queries:</p>

<p>###Consumption</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">GiftsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">search_params</span> <span class="o">=</span> <span class="no">SearchBuilder</span><span class="p">.</span>
      <span class="nf">filter</span><span class="p">(</span><span class="ss">organization_id: </span><span class="n">current_organization</span><span class="p">.</span><span class="nf">id</span><span class="p">).</span>
      <span class="nf">filter</span><span class="p">(</span><span class="ss">user_id: </span><span class="n">current_user</span><span class="p">.</span><span class="nf">id</span><span class="p">).</span>
      <span class="nf">filter</span><span class="p">(</span><span class="ss">created_at: </span><span class="p">{</span> <span class="ss">gte: </span><span class="mi">5</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">ago</span> <span class="p">}).</span>
      <span class="nf">sort</span><span class="p">(</span><span class="s1">'id desc'</span><span class="p">)</span>

    <span class="vi">@gifts</span> <span class="o">=</span> <span class="no">Gift</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">search_params</span><span class="p">).</span><span class="nf">page</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:page</span><span class="p">]).</span><span class="nf">records</span>
  <span class="k">end</span>
  <span class="o">...</span>
<span class="k">end</span></code></pre></figure>

<p>In part 2, we’ll take the next step support even more ElasticSearch queries and see what it would take to make this badboy a gem.</p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2019/12/31/books-worth-reading-2019/">
            Books Worth Reading 2019
            <small>31 Dec 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/12/31/books-worth-reading-2018/">
            Books Worth Reading 2018
            <small>31 Dec 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/08/12/counting-crowds-with-coreml/">
            Moving AI from the Cloud to the Edge with Crowd Count and Apple's Core ML
            <small>12 Aug 2018</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'dimroc'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'dimroc'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
  var s = document.createElement('script'); s.async = true;
  s.type = 'text/javascript';
  s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>


  </body>
</html>
