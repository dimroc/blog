<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Not All Migrations are Equal: Schema vs. Data &middot; dimroc
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/tagging.css">
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="/public/css/custom.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

  <!-- Javascript -->
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
  <script src="/public/javascript/detectmobilebrowser.js"></script>

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-43559997-2', 'auto');
  ga('send', 'pageview');
</script>

</head>


  <body class="sidebar-overlay">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Blog</a>
    <a class="sidebar-nav-item" href="https://github.com/dimroc">GitHub</a>
    <a class="sidebar-nav-item" href="http://experiments.dimroc.com">Experiments</a>

    

    
    
      
        
      
    
      
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    

    <a class="sidebar-nav-item" href="https://twitter.com/dimroc">@dimroc</a>
  </nav>

  <div class="sidebar-item">
    <p>Tags</p>
  </div>

  <nav class="sidebar-nav">
    
    
      <a class="sidebar-nav-item" href=/tag/webgl>webgl</a>
    
      <a class="sidebar-nav-item" href=/tag/javascript>javascript</a>
    
      <a class="sidebar-nav-item" href=/tag/twitter>twitter</a>
    
      <a class="sidebar-nav-item" href=/tag/nyc>nyc</a>
    
      <a class="sidebar-nav-item" href=/tag/elasticsearch>elasticsearch</a>
    
      <a class="sidebar-nav-item" href=/tag/ios>ios</a>
    
      <a class="sidebar-nav-item" href=/tag/ruby>ruby</a>
    
      <a class="sidebar-nav-item" href=/tag/elixir>elixir</a>
    
      <a class="sidebar-nav-item" href=/tag/golang>golang</a>
    
      <a class="sidebar-nav-item" href=/tag/scala>scala</a>
    
      <a class="sidebar-nav-item" href=/tag/etl>etl</a>
    
      <a class="sidebar-nav-item" href=/tag/swift>swift</a>
    
      <a class="sidebar-nav-item" href=/tag/testing>testing</a>
    
      <a class="sidebar-nav-item" href=/tag/rails>rails</a>
    
      <a class="sidebar-nav-item" href=/tag/python>python</a>
    
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2015. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h2 class="masthead-title">
            <a href="/" title="Home">dimroc</a>
            <small>blog</small>
            <span class="masthead-links">
              <a href="http://experiments.dimroc.com" title="Experiments">See Experiments</a>
            </span>
          </h2>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Not All Migrations are Equal: Schema vs. Data</h1>
  <span class="post-date">11 Dec 2014</span>
  <span class="post-comments"><a href="#disqus_thread"></a></span>
  <p><em>Update 01/26/2015: Check out the <a href="https://github.com/jasonfb/nondestructive_migrations">nondestructive_migrations</a> gem. It&#39;s similar to dimroc/datafix but simpler because it
leverages existing AR code. It does not however generate specs... yet.</em></p>

<hr>

<p>You&#39;ve been using <a href="http://api.rubyonrails.org/classes/ActiveRecord/Migration.html">Active Record Migrations</a> to manage changes in
your database and you love it. But then a model&#39;s validations change, and all your existing data becomes invalid.</p>

<p>What do you do? Place it in an AR migration? Depends. Those are primarily for <strong>schema migrations</strong> and this is not a schema change.</p>

<p>You need to run a <strong>data migration</strong>.</p>

<!--more-->

<p>What are your options?</p>

<h2>Stuff it into an AR migration? If it&#39;s simple enough.</h2>

<p>It would probably be your first move. Sure, you can get away with a few hundred or even thousand of rows
and no one will break a sweat. Let&#39;s look at how you would do that.</p>

<h3>Bad Schema Migration</h3>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">ChangeAdminDefaultToFalseOnUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">up</span>
    <span class="n">change_column_default</span><span class="p">(</span><span class="ss">:users</span><span class="p">,</span> <span class="ss">:admin</span><span class="p">,</span> <span class="kp">false</span><span class="p">)</span>
    <span class="no">User</span><span class="o">.</span><span class="n">reset_column_information</span>

    <span class="c1"># Bad: Use of application code that changes over time.</span>
    <span class="no">User</span><span class="o">.</span><span class="n">update_null_to_false!</span> 
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<h3>Good Schema Migration</h3>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">ChangeAdminDefaultToFalseOnUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="c1"># Create empty AR model that will attach to the users table,</span>
  <span class="c1"># and isolate migration from application code.</span>
  <span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">;</span> <span class="k">end</span>

  <span class="k">def</span> <span class="nf">up</span>
    <span class="n">change_column_default</span><span class="p">(</span><span class="ss">:users</span><span class="p">,</span> <span class="ss">:admin</span><span class="p">,</span> <span class="kp">false</span><span class="p">)</span>
    <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">admin</span><span class="p">:</span><span class="kp">nil</span><span class="p">)</span><span class="o">.</span><span class="n">update_all</span><span class="p">(</span><span class="ss">admin</span><span class="p">:</span> <span class="kp">false</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<h3>Better Schema Migration</h3>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">ChangeAdminDefaultToFalseOnUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">up</span>
    <span class="n">change_column_default</span><span class="p">(</span><span class="ss">:users</span><span class="p">,</span> <span class="ss">:admin</span><span class="p">,</span> <span class="kp">false</span><span class="p">)</span>
    <span class="n">execute</span> <span class="s2">&quot;UPDATE users SET admin = false WHERE admin IS NULL&quot;</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>Everything in <strong>db/migrate/</strong> has to live for the life
of the application, which is why using application code in an AR migration is frowned upon (sure, you can move onto schema:load and delete migrations, but let&#39;s keep things simple for now).</p>

<p>That application code will change months or even weeks from now, and then running <code>rake db:migrate</code> will be busted.</p>

<p>Most people get by using the <strong>Good</strong> and <strong>Better</strong> schema migration methods, but there comes a time when either the scale
or the complexity of the migration warrants its own code. The time when pure SQL will only get you so far or when the runtime of the migration
spans days not seconds.</p>

<p>What do you do?</p>

<h2>Create a one off rake task? No.</h2>

<p>Perhaps, but the code will be difficult to test and won&#39;t have mechanisms in place to roll back to changes. Even if you refactor the logic out of
the rake task into a separate ruby class, you will now have to maintain code that is ephemeral in nature. It merely exists for this one off data migration.</p>

<p>One approach is to create a <strong>oneshots.rake</strong> file, but that ends up being a ghetto of random tasks with no test coverage that never gets cleaned up </p>

<h1><a href="https://github.com/dimroc/datafix">Datafixes!</a> Yes.</h1>

<p>Basically a mirror of AR migrations, every rails user will feel right at home with <a href="https://github.com/dimroc/datafix">datafixes</a>.</p>

<p>Install the gem from my repo:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">gem</span> <span class="s1">&#39;datafix&#39;</span><span class="p">,</span> <span class="ss">github</span><span class="p">:</span> <span class="s1">&#39;dimroc/datafix&#39;</span> <span class="c1"># The changes will eventually be incorporated into the main gem `datafix`</span></code></pre></div>

<p>Run the generator to create the datafix template:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">&gt; rails g datafix AddValidWholesalePriceToProducts
  create  db/datafixes/20141211143848_add_valid_wholesale_price_to_products.rb
  create  spec/db/datafixes/20141211143848_add_valid_wholesale_price_to_products_spec.rb</code></pre></div>

<p>Fill out the datafix with your data migration:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Datafixes</span><span class="o">::</span><span class="no">AddValidWholesalePriceToProducts</span> <span class="o">&lt;</span> <span class="no">Datafix</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">up</span>
    <span class="no">Product</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">wholesale_price_cents</span><span class="p">:</span> <span class="kp">nil</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span>
      <span class="n">product</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">({</span>
        <span class="ss">wholesale_price_cents</span><span class="p">:</span> <span class="n">product</span><span class="o">.</span><span class="n">fetch_price_from_amazon</span>
      <span class="p">})</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">down</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>Then just run the rake tasks:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">&gt; rake db:datafix
  migrating AddValidWholesalePriceToProducts up

&gt; rake db:datafix:status

  database: somedatabase_development

   Status   Datafix ID            Datafix Name
  --------------------------------------------------
     up    <span class="m">20141211143848</span>       AddValidWholesalePriceToProducts</code></pre></div>

<p>Unlike AR migrations, it generates specs:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s2">&quot;rails_helper&quot;</span>
<span class="nb">require</span> <span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;db&quot;</span><span class="p">,</span> <span class="s2">&quot;datafixes&quot;</span><span class="p">,</span> <span class="s2">&quot;20141211143848_add_valid_wholesale_price_to_products&quot;</span><span class="p">)</span>

<span class="n">describe</span> <span class="no">Datafixes</span><span class="o">::</span><span class="no">AddValidWholesalePriceToProducts</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s2">&quot;.up&quot;</span> <span class="k">do</span>
    <span class="c1"># Fill out the describe block</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:product</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">product</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">:product</span><span class="p">,</span> <span class="ss">wholesale_price_cents</span><span class="p">:</span> <span class="kp">nil</span><span class="p">)</span>
      <span class="n">product</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="ss">validate</span><span class="p">:</span> <span class="kp">false</span><span class="p">)</span>
      <span class="n">product</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should fix the price and be valid&quot;</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">product</span><span class="p">)</span><span class="o">.</span><span class="n">to_not</span> <span class="n">be_valid</span>
      <span class="n">subject</span><span class="o">.</span><span class="n">migrate</span><span class="p">(</span><span class="s1">&#39;up&#39;</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">product</span><span class="o">.</span><span class="n">reload</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_valid</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>And the real kicker: when the code has overstayed its welcome, you can just delete the datafix. That&#39;s not so simple with a schema migration in <strong>db/migrate/</strong>. 
The datafix is ephemeral in nature and isn&#39;t worth maintaining months down the road.</p>

<p>This is super handy in all the scenarios:</p>

<ol>
<li>Denormalizing values to another table</li>
<li>Changing data to comply with changing validations</li>
<li>Long running data migrations that span days</li>
<li>Migrating from one table to another</li>
</ol>

<h2>Wrap Up</h2>

<p>For data migrations, datafixes are far better than anything out there, but it&#39;s still brand new and rough around the edges. It doesn&#39;t even have
<strong>rake db:datafix:rollback</strong> yet! <a href="https://github.com/dimroc/datafix">Check it out!</a></p>

<h3>Note</h3>

<p><em>The</em> <a href="https://github.com/dimroc/datafix"><strong>dimroc</strong></a> <em>fork has many upgrades to the Casecommons version, including the rake tasks that function like *rake db:migrate</em>. It will eventually be incorporated into the Casecommons version
when they stop sending email and look at the PR.*</p>

<h3>References</h3>

<ul>
<li><a href="https://github.com/Casecommons/datafix">Casecommons/datafix</a></li>
<li><a href="http://railsguides.net/change-data-in-migrations-like-a-boss">Change data in migrations like a boss</a></li>
<li><a href="https://www.honeybadger.io/blog/2013/08/06/zero-downtime-migrations-of-large-databases-using-rails-postgres-and-redis">Zero Downtime Migrations of Large Databases - Honeybadger</a></li>
</ul>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2015/05/07/etl-language-showdown-pt2/">
            Comparing Golang, Scala, Elixir, Ruby, and now Python3 for ETL: Part 2
            <small>07 May 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2015/04/20/amazon-lambda-for-autoscaling-work/">
            Amazon Lambda to Autoscale Background Work
            <small>20 Apr 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2015/01/30/heroku-announces-ability-to-share-addons/">
            Heroku announces ability to share apps as add ons
            <small>30 Jan 2015</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'dimroc'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'dimroc'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
  var s = document.createElement('script'); s.async = true;
  s.type = 'text/javascript';
  s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>


  </body>
</html>
