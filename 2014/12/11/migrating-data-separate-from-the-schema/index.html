<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!--iPhone preview -->
  <meta property="og:title" content="Not All Migrations are Equal: Schema vs. Data" />
  <meta property="og:image" content="/" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Not All Migrations are Equal: Schema vs. Data &middot; dimroc
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/tagging.css">
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="/public/css/custom.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

  <!-- Javascript -->
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
  <script src="/public/javascript/detectmobilebrowser.js"></script>

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  <meta name="google-site-verification" content="KFJOcbe4F4sAQcx11yd_6hmxu0DVdy6ZgI7y6TFK8VU" />
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-43559997-2', 'auto');
  ga('send', 'pageview');
</script>

</head>


  <body class="sidebar-overlay">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Blog</a>
    <a class="sidebar-nav-item" href="https://github.com/dimroc">GitHub</a>
    <a class="sidebar-nav-item" href="https://experiments.dimroc.com">Experiments</a>

    

    
    
      
        
      
    
      
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    

    <a class="sidebar-nav-item" href="https://twitter.com/dimroc">@dimroc</a>
  </nav>

  <div class="sidebar-item">
    <p>Tags</p>
  </div>

  <nav class="sidebar-nav">
    
    
      <a class="sidebar-nav-item" href=/tag/webgl/>webgl</a>
    
      <a class="sidebar-nav-item" href=/tag/javascript/>javascript</a>
    
      <a class="sidebar-nav-item" href=/tag/twitter/>twitter</a>
    
      <a class="sidebar-nav-item" href=/tag/nyc/>nyc</a>
    
      <a class="sidebar-nav-item" href=/tag/elasticsearch/>elasticsearch</a>
    
      <a class="sidebar-nav-item" href=/tag/ios/>ios</a>
    
      <a class="sidebar-nav-item" href=/tag/ruby/>ruby</a>
    
      <a class="sidebar-nav-item" href=/tag/elixir/>elixir</a>
    
      <a class="sidebar-nav-item" href=/tag/golang/>golang</a>
    
      <a class="sidebar-nav-item" href=/tag/scala/>scala</a>
    
      <a class="sidebar-nav-item" href=/tag/etl/>etl</a>
    
      <a class="sidebar-nav-item" href=/tag/swift/>swift</a>
    
      <a class="sidebar-nav-item" href=/tag/testing/>testing</a>
    
      <a class="sidebar-nav-item" href=/tag/rails/>rails</a>
    
      <a class="sidebar-nav-item" href=/tag/python/>python</a>
    
      <a class="sidebar-nav-item" href=/tag/business/>business</a>
    
      <a class="sidebar-nav-item" href=/tag/go/>go</a>
    
      <a class="sidebar-nav-item" href=/tag/docker/>docker</a>
    
      <a class="sidebar-nav-item" href=/tag/react/>react</a>
    
      <a class="sidebar-nav-item" href=/tag/tutum/>tutum</a>
    
      <a class="sidebar-nav-item" href=/tag/aws/>aws</a>
    
      <a class="sidebar-nav-item" href=/tag/machine-learning/>machine-learning</a>
    
      <a class="sidebar-nav-item" href=/tag/angular/>angular</a>
    
      <a class="sidebar-nav-item" href=/tag/finance/>finance</a>
    
      <a class="sidebar-nav-item" href=/tag/books/>books</a>
    
      <a class="sidebar-nav-item" href=/tag/octave/>octave</a>
    
      <a class="sidebar-nav-item" href=/tag/kubernetes/>kubernetes</a>
    
      <a class="sidebar-nav-item" href=/tag/coreml/>coreml</a>
    
      <a class="sidebar-nav-item" href=/tag/ml/>ml</a>
    
      <a class="sidebar-nav-item" href=/tag/games/>games</a>
    
      <a class="sidebar-nav-item" href=/tag/ai/>ai</a>
    
      <a class="sidebar-nav-item" href=/tag/genai/>genai</a>
    
      <a class="sidebar-nav-item" href=/tag/godot/>godot</a>
    
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2023. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h2 class="masthead-title">
            <a href="/" title="Home">dimroc</a>
            <small>blog</small>
            <span class="masthead-links">
              <a href="https://experiments.dimroc.com" title="Experiments">See Experiments</a>
            </span>
          </h2>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Not All Migrations are Equal: Schema vs. Data</h1>
  <span class="post-date">11 Dec 2014</span>
  <span class="post-comments"><a href="#disqus_thread"></a></span>
  <p><em>Update 01/26/2015: Check out the <a href="https://github.com/jasonfb/nondestructive_migrations">nondestructive_migrations</a> gem. It’s similar to dimroc/datafix but simpler because it
leverages existing AR code. It does not however generate specs… yet.</em></p>

<hr />

<p>You’ve been using <a href="http://api.rubyonrails.org/classes/ActiveRecord/Migration.html">Active Record Migrations</a> to manage changes in
your database and you love it. But then a model’s validations change, and all your existing data becomes invalid.</p>

<p>What do you do? Place it in an AR migration? Depends. Those are primarily for <strong>schema migrations</strong> and this is not a schema change.</p>

<p>You need to run a <strong>data migration</strong>.</p>

<!--more-->

<p>What are your options?</p>

<h2 id="stuff-it-into-an-ar-migration-if-its-simple-enough">Stuff it into an AR migration? If it’s simple enough.</h2>

<p>It would probably be your first move. Sure, you can get away with a few hundred or even thousand of rows
and no one will break a sweat. Let’s look at how you would do that.</p>

<h3 id="bad-schema-migration">Bad Schema Migration</h3>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">ChangeAdminDefaultToFalseOnUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">up</span>
    <span class="n">change_column_default</span><span class="p">(</span><span class="ss">:users</span><span class="p">,</span> <span class="ss">:admin</span><span class="p">,</span> <span class="kp">false</span><span class="p">)</span>
    <span class="no">User</span><span class="p">.</span><span class="nf">reset_column_information</span>

    <span class="c1"># Bad: Use of application code that changes over time.</span>
    <span class="no">User</span><span class="p">.</span><span class="nf">update_null_to_false!</span> 
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<h3 id="good-schema-migration">Good Schema Migration</h3>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">ChangeAdminDefaultToFalseOnUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="c1"># Create empty AR model that will attach to the users table,</span>
  <span class="c1"># and isolate migration from application code.</span>
  <span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">;</span> <span class="k">end</span>

  <span class="k">def</span> <span class="nf">up</span>
    <span class="n">change_column_default</span><span class="p">(</span><span class="ss">:users</span><span class="p">,</span> <span class="ss">:admin</span><span class="p">,</span> <span class="kp">false</span><span class="p">)</span>
    <span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">admin</span><span class="ss">:nil</span><span class="p">).</span><span class="nf">update_all</span><span class="p">(</span><span class="ss">admin: </span><span class="kp">false</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<h3 id="better-schema-migration">Better Schema Migration</h3>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">ChangeAdminDefaultToFalseOnUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">up</span>
    <span class="n">change_column_default</span><span class="p">(</span><span class="ss">:users</span><span class="p">,</span> <span class="ss">:admin</span><span class="p">,</span> <span class="kp">false</span><span class="p">)</span>
    <span class="n">execute</span> <span class="s2">"UPDATE users SET admin = false WHERE admin IS NULL"</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>With most people’s usage pattern, everything in <strong>db/migrate/</strong> has to live for months due to habitual <code class="language-plaintext highlighter-rouge">rake db:migrate</code> invocations,
which is why using application code in an AR migration is frowned upon (sure, you can move onto schema:load and delete migrations, but let’s keep things simple for now).</p>

<p>That application code will change weeks or even days from now, and then running <code class="language-plaintext highlighter-rouge">rake db:migrate</code> will be busted.</p>

<p>Most people get by using the <strong>Good</strong> and <strong>Better</strong> schema migration methods, but there comes a time when either the scale
or the complexity of the migration warrants its own code. The time when pure SQL will only get you so far or when the runtime of the migration
spans days not seconds.</p>

<p>What do you do?</p>

<h2 id="create-a-one-off-rake-task-no">Create a one off rake task? No.</h2>

<p>Perhaps, but the code will be difficult to test and won’t have mechanisms in place to roll back to changes. Even if you refactor the logic out of
the rake task into a separate ruby class, you will now have to maintain code that is ephemeral in nature. It merely exists for this one off data migration.</p>

<p>One approach is to create a <strong>oneshots.rake</strong> file, but that ends up being a ghetto of random tasks with no test coverage that never gets cleaned up</p>

<h1 id="datafixes-yes"><a href="https://github.com/dimroc/datafix">Datafixes!</a> Yes.</h1>

<p>Basically a mirror of AR migrations, every rails user will feel right at home with <a href="https://github.com/dimroc/datafix">datafixes</a>.</p>

<p>Install the gem from my repo:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">gem</span> <span class="s1">'datafix'</span><span class="p">,</span> <span class="ss">github: </span><span class="s1">'dimroc/datafix'</span> <span class="c1"># The changes will eventually be incorporated into the main gem `datafix`</span></code></pre></figure>

<p>Run the generator to create the datafix template:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">&gt;</span> rails g datafix AddValidWholesalePriceToProducts
  create  db/datafixes/20141211143848_add_valid_wholesale_price_to_products.rb
  create  spec/db/datafixes/20141211143848_add_valid_wholesale_price_to_products_spec.rb</code></pre></figure>

<p>Fill out the datafix with your data migration:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Datafixes::AddValidWholesalePriceToProducts</span> <span class="o">&lt;</span> <span class="no">Datafix</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">up</span>
    <span class="no">Product</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">wholesale_price_cents: </span><span class="kp">nil</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span>
      <span class="n">product</span><span class="p">.</span><span class="nf">update_attributes</span><span class="p">({</span>
        <span class="ss">wholesale_price_cents: </span><span class="n">product</span><span class="p">.</span><span class="nf">fetch_price_from_amazon</span>
      <span class="p">})</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">down</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Then just run the rake tasks:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">&gt;</span> rake db:datafix
  migrating AddValidWholesalePriceToProducts up

<span class="o">&gt;</span> rake db:datafix:status

  database: somedatabase_development

   Status   Datafix ID            Datafix Name
  <span class="nt">--------------------------------------------------</span>
     up    20141211143848       AddValidWholesalePriceToProducts</code></pre></figure>

<p>Unlike AR migrations, it generates specs:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s2">"rails_helper"</span>
<span class="nb">require</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"db"</span><span class="p">,</span> <span class="s2">"datafixes"</span><span class="p">,</span> <span class="s2">"20141211143848_add_valid_wholesale_price_to_products"</span><span class="p">)</span>

<span class="n">describe</span> <span class="no">Datafixes</span><span class="o">::</span><span class="no">AddValidWholesalePriceToProducts</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s2">".up"</span> <span class="k">do</span>
    <span class="c1"># Fill out the describe block</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:product</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">product</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="ss">:product</span><span class="p">,</span> <span class="ss">wholesale_price_cents: </span><span class="kp">nil</span><span class="p">)</span>
      <span class="n">product</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="ss">validate: </span><span class="kp">false</span><span class="p">)</span>
      <span class="n">product</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"should fix the price and be valid"</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">product</span><span class="p">).</span><span class="nf">to_not</span> <span class="n">be_valid</span>
      <span class="n">subject</span><span class="p">.</span><span class="nf">migrate</span><span class="p">(</span><span class="s1">'up'</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">product</span><span class="p">.</span><span class="nf">reload</span><span class="p">).</span><span class="nf">to</span> <span class="n">be_valid</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>And the real kicker: when the code has overstayed its welcome, you can just delete the datafix. That’s not so simple with a schema migration in <strong>db/migrate/</strong>. 
The datafix is ephemeral in nature and isn’t worth maintaining months down the road.</p>

<p>This is super handy in all the scenarios:</p>

<ol>
  <li>Denormalizing values to another table</li>
  <li>Changing data to comply with changing validations</li>
  <li>Long running data migrations that span days</li>
  <li>Migrating from one table to another</li>
</ol>

<h2 id="wrap-up">Wrap Up</h2>

<p>For data migrations, datafixes are far better than anything out there, but it’s still brand new and rough around the edges. It doesn’t even have
<strong>rake db:datafix:rollback</strong> yet! <a href="https://github.com/dimroc/datafix">Check it out!</a></p>

<h3 id="note">Note</h3>
<p><em>The</em> <a href="https://github.com/dimroc/datafix"><strong>dimroc</strong></a> <em>fork has many upgrades to the Casecommons version, including the rake tasks that function like *rake db:migrate</em>. It will eventually be incorporated into the Casecommons version
when they stop sending email and look at the PR.*</p>

<h3 id="references">References</h3>

<ul>
  <li><a href="https://github.com/Casecommons/datafix">Casecommons/datafix</a></li>
  <li><a href="http://railsguides.net/change-data-in-migrations-like-a-boss">Change data in migrations like a boss</a></li>
  <li><a href="https://www.honeybadger.io/blog/2013/08/06/zero-downtime-migrations-of-large-databases-using-rails-postgres-and-redis">Zero Downtime Migrations of Large Databases - Honeybadger</a></li>
</ul>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2023/06/11/game-to-video-w-genai/">
            Game to Video: Using Generative AI to Uprender Gameplay
            <small>11 Jun 2023</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2019/12/31/books-worth-reading-2019/">
            Books Worth Reading 2019
            <small>31 Dec 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/12/31/books-worth-reading-2018/">
            Books Worth Reading 2018
            <small>31 Dec 2018</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'dimroc'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'dimroc'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
  var s = document.createElement('script'); s.async = true;
  s.type = 'text/javascript';
  s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>


  </body>
</html>
