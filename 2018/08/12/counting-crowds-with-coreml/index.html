<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!--iPhone preview -->
  <meta property="og:title" content="Moving AI from the Cloud to the Edge with Crowd Count and Apple's Core ML" />
  <meta property="og:image" content="/public/images/count/CrowdCountiOS.experiment.gif" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Moving AI from the Cloud to the Edge with Crowd Count and Apple's Core ML &middot; dimroc
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/tagging.css">
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="/public/css/custom.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

  <!-- Javascript -->
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
  <script src="/public/javascript/detectmobilebrowser.js"></script>

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  <meta name="google-site-verification" content="KFJOcbe4F4sAQcx11yd_6hmxu0DVdy6ZgI7y6TFK8VU" />
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-43559997-2', 'auto');
  ga('send', 'pageview');
</script>

</head>


  <body class="sidebar-overlay">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Blog</a>
    <a class="sidebar-nav-item" href="https://github.com/dimroc">GitHub</a>
    <a class="sidebar-nav-item" href="https://experiments.dimroc.com">Experiments</a>

    

    
    
      
        
      
    
      
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    

    <a class="sidebar-nav-item" href="https://twitter.com/dimroc">@dimroc</a>
  </nav>

  <div class="sidebar-item">
    <p>Tags</p>
  </div>

  <nav class="sidebar-nav">
    
    
      <a class="sidebar-nav-item" href=/tag/webgl/>webgl</a>
    
      <a class="sidebar-nav-item" href=/tag/javascript/>javascript</a>
    
      <a class="sidebar-nav-item" href=/tag/twitter/>twitter</a>
    
      <a class="sidebar-nav-item" href=/tag/nyc/>nyc</a>
    
      <a class="sidebar-nav-item" href=/tag/elasticsearch/>elasticsearch</a>
    
      <a class="sidebar-nav-item" href=/tag/ios/>ios</a>
    
      <a class="sidebar-nav-item" href=/tag/ruby/>ruby</a>
    
      <a class="sidebar-nav-item" href=/tag/elixir/>elixir</a>
    
      <a class="sidebar-nav-item" href=/tag/golang/>golang</a>
    
      <a class="sidebar-nav-item" href=/tag/scala/>scala</a>
    
      <a class="sidebar-nav-item" href=/tag/etl/>etl</a>
    
      <a class="sidebar-nav-item" href=/tag/swift/>swift</a>
    
      <a class="sidebar-nav-item" href=/tag/testing/>testing</a>
    
      <a class="sidebar-nav-item" href=/tag/rails/>rails</a>
    
      <a class="sidebar-nav-item" href=/tag/python/>python</a>
    
      <a class="sidebar-nav-item" href=/tag/business/>business</a>
    
      <a class="sidebar-nav-item" href=/tag/go/>go</a>
    
      <a class="sidebar-nav-item" href=/tag/docker/>docker</a>
    
      <a class="sidebar-nav-item" href=/tag/react/>react</a>
    
      <a class="sidebar-nav-item" href=/tag/tutum/>tutum</a>
    
      <a class="sidebar-nav-item" href=/tag/aws/>aws</a>
    
      <a class="sidebar-nav-item" href=/tag/machine-learning/>machine-learning</a>
    
      <a class="sidebar-nav-item" href=/tag/angular/>angular</a>
    
      <a class="sidebar-nav-item" href=/tag/finance/>finance</a>
    
      <a class="sidebar-nav-item" href=/tag/books/>books</a>
    
      <a class="sidebar-nav-item" href=/tag/octave/>octave</a>
    
      <a class="sidebar-nav-item" href=/tag/kubernetes/>kubernetes</a>
    
      <a class="sidebar-nav-item" href=/tag/coreml/>coreml</a>
    
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2023. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h2 class="masthead-title">
            <a href="/" title="Home">dimroc</a>
            <small>blog</small>
            <span class="masthead-links">
              <a href="https://experiments.dimroc.com" title="Experiments">See Experiments</a>
            </span>
          </h2>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Moving AI from the Cloud to the Edge with Crowd Count and Apple's Core ML</h1>
  <span class="post-date">12 Aug 2018</span>
  <span class="post-comments"><a href="#disqus_thread"></a></span>
  <p><img src="/public/images/count/CrowdCountiOS.gif" alt="iOS Crowd Counting in action" /></p>

<p>After successfully counting crowds in python, <a href="/2017/11/19/counting-crowds-and-lines/">which you can read about
here</a>, I took it upon myself to run the very same models
on the iPhone with Core ML (ML: Machine Learning).
Core ML and MLKit open up a new domain for computing that’s being branded as Edge AI, where neural networks run on a local device (edge) as opposed to the cloud.
The <a href="https://github.com/dimroc/count/tree/master/ios">source code for this experiment is available here</a>.</p>

<p>Transitioning from a fixed camera <a href="https://count.dimroc.com">(ShakeCam Madison Square Park)</a>
to a general purpose iPhone app meant handling a wider variety of input. Are we counting three
people or three thousand people?
In this article, we’ll go over eight facets of the port, from migrating Cloud AI to Edge AI
to handling wildly different inputs:</p>

<ol>
  <li>Using a two stage ML pipeline to handle different inputs</li>
  <li>First stage: Building the Crowd Classifier with Create ML</li>
  <li>Second stage: Different densities, different prediction models: singles, tens, hundreds+</li>
  <li>Python coremltools to convert Keras to Core ML</li>
  <li>Why an Xcode Playground for Core ML became a macOS App (Playgrounds are too brittle)</li>
  <li>Swift Architecture: RxSwift and MVVM</li>
  <li>Performance: Better than expected</li>
  <li>Promising Future for Edge AI</li>
</ol>

<hr />

<h2 id="1-using-a-two-stage-ml-pipeline-to-handle-different-inputs">1. Using a two stage ML pipeline to handle different inputs</h2>

<p>iPhone camera input can vary wildly. Are we counting a selfie or a football stadium?
Our counting model doesn’t handle that type of variety well.
To mitigate this, we tailor make prediction models to accommodate a particular
density, and then use image classification to pick the best strategy.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Crowd Classification -&gt; either singles, tens or hundreds crowd prediction -&gt; count of people
</code></pre></div></div>

<p><img src="/public/images/count/CrowdCountStrategies.jpg" alt="Crowd Count Strategies" width="600px" /></p>

<h2 id="2-building-the-crowd-classifier-with-create-ml">2. Building the Crowd Classifier with Create ML</h2>

<p>Apple’s new <a href="https://developer.apple.com/documentation/createml">Create ML tool</a>
allows you to build a classifier by simply dragging in a folder.
This was used to classify images as either singles, tens, or hundreds, as a first step
in the ML pipeline.</p>

<p><img src="/public/images/count/CrowdClassifier.png" alt="Crowd Classifier" width="600px" /></p>

<h2 id="3-different-densities-different-prediction-models-singles-tens-hundreds">3. Different densities, different prediction models: singles, tens, hundreds+</h2>

<p>These crowd counting models (from the previous post) are heavily skewed to particular densities. For example,
the model used to count three people, will have a hard time with one thousand people.
They are based on the paper <a href="https://arxiv.org/pdf/1702.02359.pdf">Multi-Scale Convolutional Neural Networks for Crowd Counting</a>.
To mitigate this, we have three models:</p>

<p><img src="/public/images/count/CrowdCountStrategies.jpg" alt="Crowd Count Strategies" width="600px" /></p>

<ul>
  <li>singles: Uses Apple’s built in face detection (<a href="https://developer.apple.com/documentation/vision/vndetectfacerectanglesrequest">VNDetectFaceRectanglesRequest</a>). You can beat it by showing the back of your head!</li>
  <li>tens: Uses the model overtrained for the <a href="https://count.dimroc.com/">ShakeCam</a> in the previous crowd counting post, which has between zero to eighty people. The tens category desparately needs a newly trained model.</li>
  <li>hundreds: Uses a model built with the <a href="http://crcv.ucf.edu/data/crowd.php">UCF Crowd dataset</a>.</li>
</ul>

<p>This would be the final step in the two step ML pipeline. These models, however,
are still in the python Keras format. Let’s convert them to Core ML.</p>

<h2 id="4-python-coremltools-to-convert-keras-to-core-ml">4. Python coremltools to convert Keras to Core ML</h2>

<p>Apple’s <a href="https://github.com/apple/coremltools">coremltools</a> convert existing
Keras models to Core ML. It worked well with one exception: arbitrarily (not fixed) sized images.</p>

<p>The top variable sized layer had to be replaced with a fixed size layer to better work
with Core ML. Variable sized input has come to Core ML, but support and documentation still has a way to go.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model</span> <span class="o">=</span> <span class="nf">load_model</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="c1"># Create a new input layer to replace the (None,None,3) input layer
</span><span class="n">input_layer</span> <span class="o">=</span> <span class="nc">InputLayer</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">675</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s">"input_1"</span><span class="p">)</span>

<span class="c1"># Save
</span><span class="n">intermediary_path</span> <span class="o">=</span> <span class="s">"tmp/reshaped_model.h5"</span>
<span class="n">model</span><span class="p">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_layer</span>
<span class="n">model</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="n">intermediary_path</span><span class="p">)</span>

<span class="c1"># Convert
</span><span class="n">coreml_model</span> <span class="o">=</span> <span class="n">coremltools</span><span class="p">.</span><span class="n">converters</span><span class="p">.</span><span class="n">Keras</span><span class="p">.</span><span class="nf">convert</span><span class="p">(</span>
    <span class="n">intermediary_path</span><span class="p">,</span>
    <span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s">'input_1'</span><span class="p">],</span>
    <span class="n">image_input_names</span><span class="o">=</span><span class="p">[</span><span class="s">'input_1'</span><span class="p">],</span>
    <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s">'density_map'</span><span class="p">])</span>

<span class="n">coreml_model</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="s">"CrowdPredictor.mlmodel"</span><span class="p">)</span>
</code></pre></div></div>

<p><a href="https://github.com/dimroc/count/blob/master/ml/crowdcount/management/commands/convert_to_coreml.py">Source</a></p>

<p>Now that we have our Core ML pipeline, a crowd classifier feeding into a crowd predictor, let’s
see it in action.</p>

<h2 id="5-why-an-xcode-playground-for-core-ml-became-a-macos-app-playgrounds-are-too-brittle">5. Why an Xcode Playground for Core ML became a macOS App (Playgrounds are too brittle)</h2>

<p>I was under the impression that the fastest way to a functional prototype was
an Xcode Playground. Inspired by Create ML, the Xcode playground promised to be
a quick and easy prototype for the iOS application.</p>

<p>When it works, it’s great.</p>

<p><img src="/public/images/count/CountPlayground.jpg" alt="Crowd Playground" width="600px" /></p>

<p>A significant downside to playgrounds however, is its inability to be an Xcode target,
meaning it is unable to have linker and build dependencies. As you use
CocoaPods or Cartography for third party library management, this will break you, and you’ll
end up with spurious errors like the follow:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>error: Couldn't lookup symbols:
  type metadata for CrowdCountApiMac.FriendlyClassification
  ...
  __swift_FORCE_LOAD_$_swiftCoreMedia
  __swift_FORCE_LOAD_$_swiftCoreAudio
  CrowdCountApiMac.FriendlyPredictor.DensityMapWidth.unsafeMutableAddressor : Swift.Int
  ...
</code></pre></div></div>

<p>The good news is that porting over to a macOS application is relativately straighforward, and will fix all of this.
A macOS app is an Xcode target and can therefore link frameworks and binaries, allowing reliable
compilation and linking.</p>

<h2 id="6-swift-architecture-rxswift-and-mvvm">6. Swift Architecture: RxSwift and MVVM</h2>

<p><a href="https://github.com/ReactiveX/RxSwift/">RxSwift</a> drove out an MVVM (Model-View-ViewModel) architecture,
where Apple’s ViewControllers are the View. So really M(VC)VM.
But these ViewController’s are lean, and merely drive the View or glue the VM.</p>

<p><img src="/public/images/count/MVCVM.jpg" alt="M(VC)VM" width="600px" /></p>

<p>There are <a href="https://medium.com/@daltonclaybrook/rxswift-mvvm-a-little-at-a-time-81ac17dcf285">many</a>
<a href="https://medium.com/@navdeepsingh_2336/creating-an-ios-app-with-mvvm-and-rxswift-in-minutes-b8800633d2e8">articles</a>
<a href="https://medium.com/@dkhuong291/rxswift-with-mvvm-e4af71413298">on this topic</a>. Feel free to google for more information.</p>

<h2 id="7-performance-better-than-expected">7. Performance: Better than expected</h2>

<p>While extracting frames from the camera in real time, classification took ~100ms and crowd counting taking ~3 seconds.
Good to see that iPhone X GPU being put to good use.</p>

<p>Word of advice: do not do your own image and MLMultiArray manipulation.
Use Apple’s Vision API, such as <a href="https://developer.apple.com/documentation/vision/vnimagerequesthandler">VNImageRequestHandler</a>,
that makes better use of hardware.</p>

<h2 id="8-promising-future-for-edge-ai">8. Promising Future for Edge AI</h2>

<p>The ability to run sophisticated neural networks, in this case
a multi-column <a href="https://adeshpande3.github.io/A-Beginner%27s-Guide-To-Understanding-Convolutional-Neural-Networks/">CNN</a>,
on your iPhone rather than the cloud, and in real time, is a watershed moment.</p>

<p>Sure, this already existed in applications like Prisma and Google translate, but the ease of development
will present many more opportunities.</p>

<p>With millions of iPhones in use, it’ll be easier than ever to crowd source data from
your willing users to improve your model, and create a virtuous cycle that will improve the product:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>usage -&gt; more data -&gt; improved usage -&gt; more data -&gt; improved usage -&gt; ...
</code></pre></div></div>

<p>This proof of concept shows that it’s doable, and that, in and of itself, is a milestone.
Add in the performance and the iPhone’s ubiquity, and we have a promising future.</p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2019/12/31/books-worth-reading-2019/">
            Books Worth Reading 2019
            <small>31 Dec 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/12/31/books-worth-reading-2018/">
            Books Worth Reading 2018
            <small>31 Dec 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2017/12/30/books-worth-reading-2017/">
            Books Worth Reading 2017
            <small>30 Dec 2017</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'dimroc'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'dimroc'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
  var s = document.createElement('script'); s.async = true;
  s.type = 'text/javascript';
  s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>


  </body>
</html>
